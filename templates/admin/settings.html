{% extends "base.html" %} 

{% block title %}Admin Settings{% endblock %} 

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4><i class="fas fa-cog"></i> Admin Settings</h4>
          <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
          </a>
        </div>
        <div class="card-body">
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            {% endif %}
          {% endwith %}
          
          <div class="row">
            <div class="col-md-12">
              <h5 class="mb-4"><i class="fas fa-trophy"></i> Level Point Requirements</h5>
              
              <!-- Current Level Overview -->
              <div class="alert alert-info mb-4">
                <h6><i class="fas fa-info-circle"></i> Current Level Structure</h6>
                <div class="row">
                  {% for level in level_settings %}
                  <div class="col-md-4 mb-2">
                    <span class="badge bg-{% if level.level_name == 'Expert' %}danger{% elif level.level_name == 'Advanced' %}warning{% elif level.level_name == 'Intermediate' %}primary{% elif level.level_name == 'Learner' %}info{% else %}secondary{% endif %} me-2">
                      {{ level.level_name }}
                    </span>
                    {{ level.points_required }}+ points
                  </div>
                  {% endfor %}
                </div>
              </div>
              
              <form method="POST" id="settingsForm">
                {% for level in level_settings %}
                <div class="mb-3">
                  <label for="{{ level.level_name.lower() }}_points" class="form-label">
                    <span class="badge bg-{% if level.level_name == 'Expert' %}danger{% elif level.level_name == 'Advanced' %}warning{% elif level.level_name == 'Intermediate' %}primary{% elif level.level_name == 'Learner' %}info{% else %}secondary{% endif %} me-2">
                      {{ level.level_name }}
                    </span>
                    Minimum Points Required
                  </label>
                  <div class="input-group">
                    <input
                      type="number"
                      class="form-control"
                      id="{{ level.level_name.lower() }}_points"
                      name="{{ level.level_name.lower() }}_points"
                      value="{{ level.points_required }}"
                      min="0"
                      max="10000"
                      step="1"
                      required
                    />
                    <span class="input-group-text">points</span>
                  </div>
                  <div class="form-text">
                    Current requirement: <strong>{{ level.points_required }} points</strong>
                    {% if not loop.first %}
                    ({{ level.points_required - level_settings[loop.index0-1].points_required }} points above {{ level_settings[loop.index0-1].level_name }})
                    {% endif %}
                  </div>
                </div>
                {% endfor %}

                <div class="alert alert-warning">
                  <i class="fas fa-exclamation-triangle"></i>
                  <strong>Important:</strong> 
                  <ul class="mb-0 mt-2">
                    <li>Level requirements must be in ascending order (each level requires more points than the previous)</li>
                    <li>Changes will automatically update all user levels based on their current points</li>
                    <li>Users will be notified of level changes on their next login</li>
                  </ul>
                </div>

                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-primary btn-lg" id="updateButton">
                    <i class="fas fa-save"></i> Update Level Requirements
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Additional Settings Section -->
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-tools"></i> Additional Settings</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6><i class="fas fa-database"></i> Database Information</h6>
              <p class="text-muted">Current database: <code>{{ 'Azure SQL' if is_azure_sql else 'SQLite' }}</code></p>
              <p class="text-muted">Environment: <code>{{ 'Production' if not debug_mode else 'Development' }}</code></p>
            </div>
            <div class="col-md-6">
              <h6><i class="fas fa-shield-alt"></i> Security Settings</h6>
              <p class="text-muted">Session timeout: <strong>24 hours</strong></p>
              <p class="text-muted">Rate limiting: <strong>5 attempts per 5 minutes</strong></p>
            </div>
          </div>
          
          <hr>
          
          <div class="row">
            <div class="col-md-12">
              <h6><i class="fas fa-user-cog"></i> Admin Actions</h6>
              <div class="btn-group" role="group">
                <a href="{{ url_for('admin_change_password') }}" class="btn btn-outline-warning">
                  <i class="fas fa-key"></i> Change Admin Password
                </a>
                <a href="{{ url_for('admin_reports') }}" class="btn btn-outline-info">
                  <i class="fas fa-chart-bar"></i> View Reports
                </a>
                <a href="{{ url_for('admin_users') }}" class="btn btn-outline-primary">
                  <i class="fas fa-users"></i> Manage Users
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('settingsForm').addEventListener('submit', function(e) {
    const updateButton = document.getElementById('updateButton');
    updateButton.disabled = true;
    updateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    
    // Validate that points are in logical ascending order
    const inputs = this.querySelectorAll('input[type="number"]');
    const values = [];
    let isValid = true;
    
    inputs.forEach(input => {
        const value = parseInt(input.value);
        if (value < 0) {
            isValid = false;
            input.classList.add('is-invalid');
        } else {
            input.classList.remove('is-invalid');
            values.push(value);
        }
    });
    
    // Check ascending order
    for (let i = 1; i < values.length; i++) {
        if (values[i] <= values[i-1]) {
            isValid = false;
            inputs[i].classList.add('is-invalid');
        }
    }
    
    if (!isValid) {
        e.preventDefault();
        updateButton.disabled = false;
        updateButton.innerHTML = '<i class="fas fa-save"></i> Update Level Requirements';
        alert('Please ensure all point values are non-negative and in ascending order.');
        return false;
    }
    
    // Confirmation for significant changes
    if (!confirm('Are you sure you want to update level requirements? This will recalculate all user levels immediately.')) {
        e.preventDefault();
        updateButton.disabled = false;
        updateButton.innerHTML = '<i class="fas fa-save"></i> Update Level Requirements';
        return false;
    }
});

// Add helpful tooltips
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips if available
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
});
</script>
{% endblock %}
