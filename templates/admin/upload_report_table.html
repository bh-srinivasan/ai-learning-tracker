<!-- Reusable table template for upload report row details -->
{% set details_to_show = filtered_details if filtered_details is defined else row_details %}

{% if details_to_show %}
    <!-- Search Box for large datasets -->
    {% if details_to_show|length > 10 %}
    <div class="mb-3">
        <div class="row">
            <div class="col-md-6">
                <input type="text" 
                       class="form-control" 
                       id="search-{{ loop.index0 if loop is defined else 'main' }}" 
                       placeholder="Search rows..." 
                       onkeyup="filterCurrentTable(this)">
            </div>
            <div class="col-md-6 text-right">
                <small class="text-muted">
                    Showing {{ details_to_show|length }} rows
                </small>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="table-responsive">
        <table class="table table-striped table-sm" id="details-table-{{ loop.index0 if loop is defined else 'main' }}">
            <thead class="thead-light">
                <tr>
                    <th width="80">Row</th>
                    <th width="100">Status</th>
                    <th>Course Title</th>
                    <th>Course URL</th>
                    <th>Message</th>
                </tr>
            </thead>
            <tbody>
                {% for detail in details_to_show %}
                <tr class="{% if detail.status == 'ERROR' %}table-danger{% elif detail.status == 'SUCCESS' %}table-success{% elif detail.status == 'SKIPPED' %}table-warning{% endif %}">
                    <td>
                        <code>#{{ detail.row_number }}</code>
                    </td>
                    <td>
                        {% if detail.status == 'SUCCESS' %}
                            <span class="badge badge-success">
                                <i class="fas fa-check"></i> Success
                            </span>
                        {% elif detail.status == 'ERROR' %}
                            <span class="badge badge-danger">
                                <i class="fas fa-exclamation-triangle"></i> Error
                            </span>
                        {% elif detail.status == 'SKIPPED' %}
                            <span class="badge badge-warning">
                                <i class="fas fa-minus"></i> Skipped
                            </span>
                        {% else %}
                            <span class="badge badge-secondary">{{ detail.status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if detail.course_title %}
                            <strong>{{ detail.course_title }}</strong>
                        {% else %}
                            <span class="text-muted">No title</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if detail.course_url %}
                            <a href="{{ detail.course_url }}" 
                               target="_blank" 
                               class="text-truncate d-inline-block" 
                               style="max-width: 200px;"
                               title="{{ detail.course_url }}">
                                {{ detail.course_url }}
                                <i class="fas fa-external-link-alt fa-sm ml-1"></i>
                            </a>
                        {% else %}
                            <span class="text-muted">No URL</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if detail.message %}
                            <span class="message-text" title="{{ detail.message }}">
                                {{ detail.message }}
                            </span>
                        {% else %}
                            <span class="text-muted">No message</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination for very large datasets -->
    {% if details_to_show|length > 100 %}
    <div class="mt-3">
        <small class="text-muted">
            <i class="fas fa-info-circle"></i>
            Large dataset detected. Consider using filters or exporting to CSV for easier management.
        </small>
    </div>
    {% endif %}

{% else %}
    <div class="text-center py-4">
        <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
        <h6 class="text-muted">No data to display</h6>
        <p class="text-muted">No rows match the current criteria.</p>
    </div>
{% endif %}

<script>
// Filter table function for search
function filterCurrentTable(input) {
    const table = input.closest('.tab-pane, .card-body').querySelector('table');
    const rows = table.getElementsByTagName('tr');
    const filter = input.value.toLowerCase();
    
    for (let i = 1; i < rows.length; i++) { // Skip header row
        const cells = rows[i].getElementsByTagName('td');
        let found = false;
        
        for (let j = 0; j < cells.length; j++) {
            if (cells[j].textContent.toLowerCase().includes(filter)) {
                found = true;
                break;
            }
        }
        
        rows[i].style.display = found ? '' : 'none';
    }
    
    // Update row count
    const visibleRows = Array.from(rows).slice(1).filter(row => row.style.display !== 'none').length;
    const countElement = input.closest('.tab-pane, .card-body').querySelector('.text-muted');
    if (countElement && countElement.textContent.includes('Showing')) {
        countElement.innerHTML = `Showing ${visibleRows} of ${rows.length - 1} rows`;
    }
}

// Truncate long messages for better table layout
document.addEventListener('DOMContentLoaded', function() {
    const messageElements = document.querySelectorAll('.message-text');
    messageElements.forEach(element => {
        if (element.textContent.length > 100) {
            const originalText = element.textContent;
            const truncatedText = originalText.substring(0, 100) + '...';
            
            element.textContent = truncatedText;
            element.style.cursor = 'pointer';
            element.classList.add('text-truncate');
            
            // Add click to expand
            element.addEventListener('click', function() {
                if (this.textContent.endsWith('...')) {
                    this.textContent = originalText;
                    this.classList.remove('text-truncate');
                } else {
                    this.textContent = truncatedText;
                    this.classList.add('text-truncate');
                }
            });
        }
    });
});
</script>
